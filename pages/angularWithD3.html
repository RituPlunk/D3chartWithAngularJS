<!DOCTYPE html>
<html data-ng-app="d3App">
<head>
<title></title>
</head>
<body data-ng-controller="d3appController as appCtrl">


	<script src="../js/Angular.min.js"></script>
	<script src="../js/d3.js"></script>
	<script>
		var app = angular.module('d3App', [])
			app.controller('d3appController',['$scope',function($scope){
				$scope.title = "DemoCtrl";
				$scope.d3Data = [
							{name: "Greg", score:68},
							{name: "Ari", score:96},
							{name: "Loser", score: 48}
				               ];
			}]);
	    app.directive('d3Bars', ['d3', function(d3) {
	      return {
	        restrict: 'EA',
	        scope: {
	          data: "=",
	          label: "@",
	          onClick: "&"
	        },
	        link: function(scope, iElement, iAttrs) {
	          var svg = d3.select(iElement[0])
	              .append("svg")
	              .attr("width", "100%");

	          // on window resize, re-render d3 canvas
	          window.onresize = function() {
	            return scope.$apply();
	          };
	          scope.$watch(function(){
	              return angular.element(window)[0].innerWidth;
	            }, function(){
	              return scope.render(scope.data);
	            }
	          );

	          // watch for data changes and re-render
	          scope.$watch('data', function(newVals, oldVals) {
	            return scope.render(newVals);
	          }, true);

	          // define render function
	          scope.render = function(data){
	            // remove all previous items before render
	            svg.selectAll("*").remove();
	            // setup variables
	            var width, height, max;
	            width = d3.select(iElement[0])[0][0].offsetWidth - 20;
	              // 20 is for margins and can be changed
	            height = scope.data.length * 35;
	              // 35 = 30(bar height) + 5(margin between bars)
	            var arr = [];
	            for(var i=0;i<scope.data.length;i++){
	            	arr.push(scope.data[i].score);
	            }
	            max = d3.max(arr);
	              // this can also be found dynamically when the data is not static
	              // max = Math.max.apply(Math, _.map(data, ((val)-> val.count)))

	            // set the height based on the calculations above
	            svg.attr('height', height);

	            //create the rectangles for the bar chart
	            svg.selectAll("rect")
	              .data(data)
	              .enter()
	                .append("rect")
	                .on("click", function(d, i){return scope.onClick({item: d});})
	                .attr("height", 30) // height of each bar
	                .attr("width", 0) // initial width of 0 for transition
	                .attr("x", 10) // half of the 20 side margin specified above
	                .attr("y", function(d, i){
	                  return i * 35;
	                }) // height + margin between bars
	                .transition()
	                  .duration(1000) // time of duration
	                  .attr("width", function(d){
	                    return d.score/(max/width);
	                  }); // width based on scale

	            svg.selectAll("text")
	              .data(data)
	              .enter()
	                .append("text")
	                .attr("fill", "#fff")
	                .attr("y", function(d, i){return i * 35 + 22;})
	                .attr("x", 15)
	                .text(function(d){return d[scope.label];});

	          };
	        }
	      };
	    }]);
		
	</script>
</body>
</html>